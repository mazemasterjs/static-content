<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>MazeMasterJS - Bot Editor</title>

    <!-- Fonts  / Icons-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Nanum+Gothic+Coding&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" />

    <!-- Monaco -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="js/monaco-editor-min/min/vs/editor/editor.main.css" />

    <!-- jQuery -->
    <script src="js/jquery-3.4.1.min.js"></script>

    <!-- jQuery UI -->
    <link rel="stylesheet" href="js/jquery-ui-1.12.1/jquery-ui.css" />

    <!-- <script src="external/jquery/jquery.js"></script> -->
    <script src="js/jquery-ui-1.12.1/jquery-ui.min.js"></script>

    <!-- MazeMaster Stuff -->
    <link href="css/style.css" rel="stylesheet" type="text/css" />
    <script src="js/enums.js"></script>
    <script src="js/gameFuncs.js"></script>
    <script src="js/declarations.js"></script>
    <script src="js/skully.js"></script>
    <script src="js/cheesy.js"></script>

    <style>
      .no-close .ui-dialog-titlebar-close {
        display: none;
      }
    </style>
  </head>

  <body>
    <header>
      <div id="pageHeader">
        <div class="grid-item">MazeMasterJS</div>
        <div class="grid-item">Hello</div>
      </div>
    </header>

    <section id="appContainer">
      <div class="controls">
        <label for="selBotVersion">Bot Version:</label>
        <select id="selBotVersion" class="autoScroll"></select>
        <button id="btnSaveBotCode" class="btnDisabled" disabled>
          Version Bot
        </button>
        <button id="btnStartBot" class="btnBot btnDisabled" disabled title="Run Bot (shortcut: F5 in editor)">Run Bot</button>
        <button id="btnStepBot" class="btnBot btnDisabled" disabled title="Run Bot (shortcut: [SHIFT + F5] in editor)">Step Bot</button>
        <button id="btnDebugBot" class="btnBot btnDisabled" disabled title="Debug Bot (shortcut: [CTRL + F5] in editor)">
          Debug Bot
          <span
            class="ui-icon ui-icon-help"
            title="Debugging Help"
            onmouseover="$('#debugDialog').dialog('open');"
            onmouseout="$('#debugDialog').dialog('close');"
          ></span>
        </button>
        <button id="btnEmergencyStop" class="btnEmergencyStop" title="Runaway bot? Click here!">
          STOP
        </button>
        <button id="btnQuit" class="btnEmergencyStop" title="Quit the current game.">
          QUIT
        </button>
      </div>

      <div id="work-grid">
        <div id="editor" class="grid-item"></div>
        <div id="output" class="grid-item">
          <div id="textLog" class="autoScroll"></div>
        </div>
      </div>

      <div class="selections">
        <!-- these controls should be replaced with a login feature -->
        <label for="selMaze">Maze:</label>
        <select name="selMaze" id="selMaze"></select>

        <label for="selTeam">Team:</label>
        <select name="selTeam" id="selTeam"></select>

        <label for="selBot">Bot:</label>
        <select name="selBot" id="selBot"></select>
      </div>
    </section>

    <div id="miniMap" class="ui-widget-content dimmable">
      <h3 class="ui-widget-header">MINI MAP</h3>
      <input type="checkbox" id="chkAutoDim" name="autoDimMiniMap" title="Toggle Mini-Map Dimmer" />
      <div id="miniMapContent" onresize="scaleMiniMap();"></div>
    </div>

    <div id="loadingDialog" title="-= LOADING =-" style="display: none">
      <p id="loadMsgHeader">MazeMasterJS.<b>botEditor</b> is now...</p>
      <p id="loadMsgBody">Loading page elements...</p>
    </div>

    <div id="debugDialog" title="Trouble Debugging?" style="display: none">
      <h3>TIP 1</h3>
      <p>The developer console need to be open for debugging. Press F12 to toggle it.</p>
      <h3>TIP 2</h3>
      <p>Put the following line somewhere in your bot code to pause execution there: <b>debugger;</b></p>
      <h3>TIP 3</h3>
      <p>If there are no <b>debugger;</b> lines in your code, execution will pause on line 1.</p>
    </div>

    <div id="emergencyStopDialog" title="EMERGENCY STOP"></div>

    <!-- Load the Monaco Editor -->
    <script>
      var require = { paths: { vs: 'js/monaco-editor-min/min/vs' } };
    </script>
    <script src="js/monaco-editor-min/min/vs/loader.js"></script>
    <script src="js/monaco-editor-min/min/vs/editor/editor.main.nls.js"></script>
    <script src="js/monaco-editor-min/min/vs/editor/editor.main.js"></script>

    <script>
      pageLoadComplete = false;

      /* CONFIGURE MONACO */
      const startingScript = "logMessage('bot', 'I am<b>&nbsp;alive!</b>', 'Shall we play a<b>&nbsp;game?</b>');";

      let model = monaco.editor.createModel(startingScript, 'javascript');

      // prettier-ignore
      monaco.languages.typescript.javascriptDefaults.addExtraLib(
          MMJS_EDITOR_LIB,
      );

      // themes: vs | vs-dark | hc-black
      $('#loadMsgBody').text('... starting the code editor');
      const editor = monaco.editor.create(document.getElementById('editor'), {
        model,
        theme: 'vs-dark',
        language: 'javascript',
        lineNumbers: 'on',
        roundedSelection: false,
        scrollBeyondLastLine: false,
        readOnly: false,
        automaticLayout: true,
        formatOnType: true,
      });

      // on page read, bind control events and start loading data
      $().ready(async () => {
        // open up the loading dialog right away
        $('#loadingDialog').dialog({
          dialogClass: 'no-close',
          width: '20vw',
          autoOpen: true,
          modal: true,
          closeOnEscape: false,
        });

        $('#loadMsgBody').text('... binding controls');

        // make miniMap stowable
        $('#miniMap > h3').dblclick(() => {
          const mm = $('#miniMap');
          if ($('#miniMapContent').css('display') === 'none') {
            $('#miniMapContent').show();
            $('#miniMap').css('height', 'var(--miniMapBaseSize)rem');
            $('#miniMap').css('width', 'var(--miniMapBaseSize)rem');
            $('#chkAutoDim').show();
            mm.resizable('enable');
            // scaleMiniMap();
          } else {
            $('#chkAutoDim').hide();
            mm.css('min-height', '0');
            mm.height($('#miniMap > h3').height());
            $('#miniMap').css('height', 'var(--miniMapBaseSize)rem');
            $('#miniMap').css('width', 'var(--miniMapBaseSize)rem');
            $('#miniMapContent').hide();
            mm.resizable('disable');
          }
        });

        $('#btnSaveBotCode').click(() => {
          versionBotCode($('#selBot :selected').val(), editor.getValue());
        });

        $('#btnStartBot').click(() => {
          EMERGENCY_STOP_BUTTON_PUSHED = false;
          startBot(false, false);
        });

        $('#btnStepBot').click(() => {
          EMERGENCY_STOP_BUTTON_PUSHED = false;
          startBot(true, false);
        });

        $('#btnDebugBot').click(() => {
          EMERGENCY_STOP_BUTTON_PUSHED = false;
          startBot(true, true);
        });

        $('#btnEmergencyStop').click(() => {
          EMERGENCY_STOP_BUTTON_PUSHED = true;
        });

        $('#btnQuit').click(() => {
          quitGame();
        });

        $('#selTeam').change(() => {
          resetGlobals();
          loadBots($('#selTeam :selected').val());
        });

        $('#selBot').change(() => {
          resetGlobals();
          loadBotVersions($('#selBot :selected').val());
          loadBotCode($('#selBot :selected').val());
        });

        $('#selBotVersion').change(() => {
          loadBotCode($('#selBot :selected').val(), $('#selBotVersion :selected').val());
        });

        // set up the debug warning dialog
        $('#debugDialog').dialog({
          width: '40vw',
          autoOpen: false,
          modal: false,
          closeText: '',
        });

        // set up the emergency stop dialog
        $('#emergencyStopDialog').dialog({
          // position: { my: 'center', at: 'center', of: editor },
          autoOpen: false,
          modal: true,
          closeOnEscape: true,
          closeText: '',
          buttons: [
            {
              text: 'lol @ u',
              icon: 'ui-icon-heart',
              click: function() {
                $(this).dialog('close');
              },
            },
          ],
        });

        // enable tool tips
        $(document).tooltip();

        // Initialize Mini-Map
        $('#miniMap').resizable({ aspectRatio: 1 });
        $('#miniMap').draggable();
        $('#miniMap').position({
          my: 'right bottom',
          at: 'right-20 bottom-15',
          of: '#editor',
          collision: 'fit',
        });

        let chkAutoDim = $('#chkAutoDim');
        chkAutoDim.change(() => {
          if (chkAutoDim.prop('checked')) {
            $('#miniMap').removeClass('dimmable');
          } else {
            $('#miniMap').addClass('dimmable');
          }
        });

        /** Set Editor Event Handlers **/
        $('#loadMsgBody').text('... configuring the code editor');

        // F5 within the code editor will run the bot
        let runBotBinding = editor.addCommand(monaco.KeyCode.F5, function() {
          startBot(false, false);
        });

        // CTRL+F5 within the code editor will debug the bot
        let debugBotBinding = editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.F5, function() {
          startBot(false, true);
        });

        // SHIFT+F5 within the code editor will step-run the bot
        let stepBotBinding = editor.addCommand(monaco.KeyMod.Shift | monaco.KeyCode.F5, function() {
          startBot(true, true);
        });

        // CTRL+S will auto-format and version the bot code
        let saveBotBinding = editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_S, function() {
          versionBotCode($('#selBot :selected').val(), editor.getValue());
        });

        // manage save button states when content changes
        editor.getModel().onDidChangeContent(event => {
          if (monaco.editor.getModelMarkers().length > 0) {
            setWarningCues(true);
          } else {
            setWarningCues(false);
          }
          if (pageLoadComplete) {
            setSaveButtonStates(true);
          }
        });

        /**
         * Dynamically scale the mini map content's font size
         */
        $('#miniMap').on('resize', function(event, ui) {
          scaleMiniMap();
        });

        // load the controls
        $('#loadMsgBody').text('... loading control data');
        await loadControls()
          .then(() => {
            pageLoadComplete = true;
            window.addEventListener('beforeunload', function(e) {
              // if save button is disabled, do not warn of lost data
              if ($('#btnSaveBotCode').hasClass('btnEnabled')) {
                e.preventDefault();
                e.returnValue = '';
              }
            });
          })
          .catch(err => {
            console.error('Erorr loading controls.', err);
          });
      });

      // keep textLog always scrolled to the bottom
      const textLog = document.querySelector('#textLog');
      const textLogObsvr = new MutationObserver(scrollToBottom);
      textLogObsvr.observe(textLog, { childList: true });
    </script>
  </body>
</html>
